<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Contact Lens Selector</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* === Lightbox zoom === */
#imgZoom {
  position: fixed; inset: 0; display: none;
  background: rgba(0,0,0,.75);
  align-items: center; justify-content: center;
  z-index: 10000; cursor: zoom-out;
}
#imgZoom.open { display: flex; }
#imgZoom img {
  max-width: 92vw; max-height: 92vh; object-fit: contain;
  box-shadow: 0 10px 24px rgba(0,0,0,.35); border-radius: 10px;
  cursor: default;
  transition: transform .15s ease;
}
#imgZoom .inner { position: relative; }
#imgZoom .hint {
  position: absolute; right: 8px; bottom: -22px; color: #eee; font-size: 11px;
  user-select: none;
}



  /* ========= Base ========= */
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    font-size: 12px;
    line-height: 1.3;
    margin: 0;
    background: #f8f8f5;
    color: #0b3d2e;
  }
  h1 { font-size: 14px; text-align: center; margin: 10px 0 12px; }
  h2 { font-size: 13px; margin: 6px 0 8px; }

  /* ========= Layout ========= */
  .container { max-width: 1100px; margin: 0 auto; padding: 10px; }
  .wrap { width: 100%; min-width: 300px; }

  /* ========= Sections ========= */
  .section {
    background: #ffffe0;
    border: 1px solid #d7d7cf;
    border-radius: 10px;
    padding: 8px;
    margin: 8px 0;
  }

.lens-card{
  padding:12px;
  border:1px solid #d7d7cf;
  border-radius:10px;
  background:#ffffe0;
  box-shadow:0 1px 0 rgba(0,0,0,.04);
  transition: box-shadow .15s ease, transform .15s ease;
}
.lens-card:hover{
  box-shadow:0 4px 10px rgba(0,0,0,.06);
  transform: translateY(-1px);
}

  .options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 6px 12px;
  }
  label { display: block; }
  input[type="checkbox"] { margin-right: 4px; }

  /* ========= Results ========= */
  .results { margin-top: 12px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
  th, td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: left;
    min-width: 70px;
    white-space: normal;
    word-wrap: break-word;
    vertical-align: top;
  }
  th { background: #e6e6d6; cursor: pointer; user-select: none; }
  th.sort-asc::after { content: " â–²"; font-size: 10px; }
  th.sort-desc::after { content: " â–¼"; font-size: 10px; }

  /* Product links (inside table) */
  #results a {
    color: #0b3d2e;
    text-decoration: none;
    font-weight: 400;
  }
  #results a:hover { color: #095c42; text-decoration: underline; }

  /* Buttons */
  button { background: #0b3d2e; color: white; border: none; padding: 6px 12px; border-radius: 10px; cursor: pointer; }
  button:disabled { background: #999; cursor: not-allowed; }
  button:hover:not(:disabled) { background: #095c42; }

  /* Search bars row */
  .search-row { display: flex; gap: 4%; margin: 12px 0; }
  .search-row input { flex: 1; padding: 6px; font-size: 12px; }

  /* ðŸ”’ Overlay for blackout */
  #overlay {
    position: fixed; inset: 0;
    background: #EDEADF;
    color: black;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    z-index: 9999;
  }

  /* Make all checkboxes green */
  input[type="checkbox"] { accent-color: #0b3d2e; }
  input[type="checkbox"]:hover { filter: brightness(1.1); }
  input[type="checkbox"]:focus {
    outline: 2px solid #0b3d2e33;
    outline-offset: 2px;
  }

  @media (max-width: 600px) {
    .container { padding: 8px; }
    .search-row { flex-direction: column; gap: 8px; }
  }
</style>
</head>
<body>

<!-- ðŸ”’ Locked screen -->
<div id="overlay">ðŸ”’ Entering password...</div>

<!-- Main content (hidden until password ok) -->
<div class="container" id="content" style="display:none;">
  <div class="wrap">
    <h1>Contact Lens Selector</h1>

    <!-- Q1: Clear or Colour -->
    <div class="section">
      <h2>Clear or coloured lenses?</h2>
      <div class="options">
        <label><input type="checkbox" name="q1" value="CLEAR">Clear</label>
        <label><input type="checkbox" name="q1" value="COLOUR">Colour</label>
      </div>
    </div>

    <!-- Q2: Modality -->
    <div class="section">
      <h2>What type of disposable?</h2>
      <div class="options">
        <label><input type="checkbox" name="q2" value="1 DAY">1 Day</label>
        <label><input type="checkbox" name="q2" value="2 WEEKS">2 Weeks</label>
        <label><input type="checkbox" name="q2" value="1 MONTH">1 Month</label>
        <label><input type="checkbox" name="q2" value="3 MONTHS">3 Months</label>
      </div>
    </div>

    <!-- Q3: Vision -->
    <div class="section">
      <h2>What type of prescription (RX)?</h2>

      <div class="options">
        <label><input type="checkbox" name="q3" value="SPH">Short or Far Sighted (SPH)</label>
        <label><input type="checkbox" name="q3" value="ASTIG">With Astigmatism (ASTIG)</label>
        <label><input type="checkbox" name="q3" value="MF">Multi-focal (MF)</label>
      </div>
    </div>

    <!-- Q4: Material -->
    <div class="section" style="display:none">
      <h2>4. What type of oxygen level? (High Oxygen keeps eyes healthy if wear long hours)</h2>
      <div class="options">
        <label><input type="checkbox" name="q4" value="SIHY">High Oxygen Lenses (SiHy)</label>
        <label><input type="checkbox" name="q4" value="HY">Standard Oxygen (Hy)</label>
      </div>
    </div>

    <!-- Q5: Standard / Premium -->
    <div class="section" style="display:none">
      <h2>5. Do you need lenses with advanced technology?</h2>
      <div class="options">
        <label><input type="checkbox" name="q5" value="PREMIUM">Extra Comfort & Performance</label>
        <label><input type="checkbox" name="q5" value="STANDARD">Standard Comfort Design</label>
      </div>
    </div>

    <!-- Q6: Loose or Not Loose -->
    <div class="section">
      <h2>Types of Packing?</h2>
      <div class="options">
        <label><input type="checkbox" name="q6" value="LOOSE">Travel Packs</label>
        <label><input type="checkbox" name="q6" value="NOT_LOOSE">Boxes</label>
      </div>
    </div>








<div class="section" id="specToCL">
  <h2>Spectacle â†’ Contact Lens Power Converter</h2>

  <!-- Input Row -->
  <div style="display:flex; align-items:flex-end; flex-wrap:wrap; gap:10px;">
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <b>Right (OD)</b>
      Sph <input id="sph-re" type="number" step="0.25" style="width:70px;text-align:center">
      Cyl <input id="cyl-re" type="number" step="0.25" style="width:70px;text-align:center">
      Axis <input id="axis-re" type="number" min="0" max="180" step="1" style="width:70px;text-align:center">
    </div>

    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <b>Left (OS)</b>
      Sph <input id="sph-le" type="number" step="0.25" style="width:70px;text-align:center">
      Cyl <input id="cyl-le" type="number" step="0.25" style="width:70px;text-align:center">
      Axis <input id="axis-le" type="number" min="0" max="180" step="1" style="width:70px;text-align:center">
    </div>

    <button id="convertBtn">Convert</button>
  </div>

  <!-- Results + Auto-fill Panel -->
  <div style="display:flex; gap:15px; margin-top:12px; align-items:flex-start; flex-wrap:wrap;">
    <div id="clOut" class="lens-card"
         style="flex:1; display:grid; grid-template-columns:1fr 1fr; gap:10px;
                background:#fffff0; border:1px solid #ccc; border-radius:10px; padding:12px;">
      <div>
        <div style="font-weight:700;margin-bottom:6px;">RE Results</div>
        <div id="reResult"></div>
      </div>
      <div>
        <div style="font-weight:700;margin-bottom:6px;">LE Results</div>
        <div id="leResult"></div>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px;">
      <button id="auto1">Auto-fill 1</button>
      <button id="auto2">Auto-fill 2</button>
      <button id="auto3">Auto-fill 3</button>
      <button id="autoSE">Auto-fill SE</button>
    </div>
  </div>
</div>




     <!-- Q7: Search --> 
    <div class="section" style="display:block;">
      <div style="display:flex; align-items:center; flex-wrap:wrap;">
        <h2>Search by Prescription; type this format: S-5.00 C-1.25 x180</h2></div>
      <div class="search-row">
        <input type="text" id="searchRE" placeholder="Search Bar Right">
        <input type="text" id="searchLE" placeholder="Search Bar Left (Use if needed)">
      </div>		  
	</div>
	  
    <div class="section" style="display:block;">
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
		<button id="promoBtn" disabled>Show Promo Only</button>
	<div style="height:10px"></div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <button id="showBtn" disabled>Loading...</button>
        <span id="btnText" style="opacity:0.8;"></span>
      </div>

    </div>
</div>
    <div class="results" id="results"></div>
    <div style="height:400px;"></div> <!-- Spacer -->
  </div>
</div>

<script>
/* =========================
   Password overlay
========================= */
(function setupPasswordGate(){
  const overlay = document.getElementById("overlay");
  const content = document.getElementById("content");
  function checkPassword() {
    let password = "";
    const correctPassword = ""; // set your password here (empty means no password)
    while (password !== correctPassword) {
      password = prompt("Please enter password to use:");
      if (password === null) {
        overlay.textContent = "Sorry, Access Denied.";
        return false;
      }
      if (password !== correctPassword) alert("Wrong password. Try again.");
    }
    return true;
  }
  window.addEventListener("load", () => {
    if (checkPassword()) {
      overlay.style.display = "none";
      content.style.display = "block";
    }
  });
})();
</script>










<script>
/* =========================
   Contact Lens Selector â€“ Cards + VALUE_PER_PAIR
   (Drop-in JS replacement, no <script> wrappers)
========================= */

const csvUrl = 'https://raw.githubusercontent.com/kiaraoptometrypx/CL-SELECTOR/main/CL%20DATABASE.csv';

let products = [];
let csvLoaded = false;

const showBtn = document.getElementById('showBtn');
const btnText = document.getElementById('btnText');

// ---------- CSV parsing (robust to quoted commas) ----------
function parseCSV(text){
  const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l => l.trim() !== '');
  if (lines.length < 2) return { headers: [], rows: [] };

  const splitRow = row =>
    row.match(/(?:,|\n|^)(?:"([^"]*(?:""[^"]*)*)"|([^",\n]*))/g)
      ?.map(s => s.replace(/^,/, ''))
      ?.map(s => s.replace(/^"|"$/g,'').replace(/""/g,'"')) || [];

  const headers = splitRow(lines[0]).map(h => h.trim());
  const rows = lines.slice(1).map(line => splitRow(line));
  return { headers, rows };
}

// ---------- Load CSV ----------
fetch(csvUrl, { cache: 'no-store' })
  .then(res => { if (!res.ok) throw new Error("HTTP "+res.status); return res.text(); })
  .then(text => {
    const { headers, rows } = parseCSV(text);
    products = rows.map(r => {
      const obj = {};
      headers.forEach((h,i) => obj[h] = (r[i] ?? '').trim());
      return obj;
    });
    csvLoaded = true;
if (showBtn) {
  showBtn.disabled = false;
  showBtn.textContent = 'Show Results';
}
if (promoBtn) {
  promoBtn.disabled = false;
  promoBtn.textContent = 'Show Promo Only';
}
	  
    if (btnText) btnText.textContent = '';
  })
  .catch(err => {
    console.error("CSV Load Error:", err);
    if (showBtn) {
      showBtn.disabled = true;
      showBtn.textContent = 'Load failed';
    }
    if (btnText) btnText.textContent = 'Please refresh to retry.';
  });

// ---------- Collect selected filters ----------
function getSelections(){
  const selected = { q1:[], q2:[], q3:[], q4:[], q5:[], q6:[] };
  document.querySelectorAll('input[type="checkbox"]:checked').forEach(c => {
    if (selected[c.name]) selected[c.name].push(c.value.toUpperCase());
  });
  return selected;
}

// ---------- Core filter per eye ----------
function filterProducts(selected, query){
  const q1Col = "LENS TYPE (CLEAR, COLOUR)";
  const mCol  = "MODALITY (1 DAY, 2 WEEKS, 1 MONTH, 3 MONTHS)";
  const vCol  = "VISION (SPH, ASTIG, MF)";
  const matCol= "MATERIAL (SIHY, HY)";
  const gCol  = "GRADE (PREMIUM, STANDARD)";

  const terms = (query || '').toLowerCase().split(/\s+/).filter(Boolean);

  return products.filter(p => {
    const lensType = (p[q1Col]  || '').trim().toUpperCase();
    const modality = (p[mCol]   || '').trim().toUpperCase();
    const vision   = (p[vCol]   || '').trim().toUpperCase();
    const material = (p[matCol] || '').trim().toUpperCase();
    const grade    = (p[gCol]   || '').trim().toUpperCase();

    if (selected.q1.length && !selected.q1.includes(lensType)) return false;
    if (selected.q2.length && !selected.q2.includes(modality)) return false;
    if (selected.q3.length && !selected.q3.includes(vision))   return false;
    if (selected.q4.length && !selected.q4.includes(material)) return false;
    if (selected.q5.length && !selected.q5.includes(grade))    return false;

    // Q6: Loose vs Not Loose â€” detect by FULL NAME containing the word "loose"
    const fullName = p["FULL NAME"] || "";
    const isLoose = /\bloose\b/i.test(fullName);
    if (selected.q6.length) {
      const wantsLoose = selected.q6.includes("LOOSE");
      const wantsNotLoose = selected.q6.includes("NOT_LOOSE");
      if (wantsLoose !== wantsNotLoose) {
        if (wantsLoose && !isLoose) return false;
        if (wantsNotLoose && isLoose) return false;
      }
    }

    // Fuzzy search
    if (terms.length) {
      const rowText = Object.values(p).join(" ").toLowerCase();
      if (!terms.every(t => rowText.includes(t))) return false;
    }

    return true;
  });
}

// ---------- Show Results (dual-eye overlap) ----------
function showResults(){
  if (!csvLoaded) return;

  const selected = getSelections();

  const reInput = (document.getElementById("searchRE")?.value || "").trim().toLowerCase();
  let   leInput = (document.getElementById("searchLE")?.value || "").trim().toLowerCase();
  if (!leInput) leInput = reInput;

  const reFiltered = filterProducts(selected, reInput);
  const leFiltered = filterProducts(selected, leInput);

  // Overlap BOTH eyes
  const setLE = new Set(leFiltered.map(p => p["FULL NAME"]));
  const overlapping = reFiltered.filter(p => setLE.has(p["FULL NAME"]));



  renderCards(overlapping);
}

// Enter to search
["searchRE","searchLE"].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); showResults(); }
  });
});

// Button
if (showBtn) showBtn.addEventListener("click", showResults);

// Promo Filter button
const promoBtn = document.getElementById("promoBtn");
if (promoBtn) {
  promoBtn.addEventListener("click", () => {
    if (!csvLoaded) return;
    const promoList = products.filter(p => (p["PROMO"] || "").trim().length > 0);
    renderCards(promoList);
  });
}

	
// ---------- Numeric parsers for sorting ----------
function getNumericPrice(p){
  // Parses first number in "1 BOX PRICE & UNIT" (e.g., "RM 120 / 30 lenses")
  const text = (p["1 BOX PRICE & UNIT"] || "").replace(/,/g, "");
  const m = text.match(/(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : Number.POSITIVE_INFINITY;
}

function getNumericValuePerPair(p){
  // Accepts formats like "RM 160 / pair", "160", "RM160", "", etc.
  const text = (p["VALUE_PER_PAIR"] || "").toString().replace(/,/g, "").trim();
  if (!text) return Number.POSITIVE_INFINITY;
  const m = text.match(/(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : Number.POSITIVE_INFINITY;
}

// ---------- Render: Sort bar + Card grid ----------
function renderCards(data){
  const container = document.getElementById("results");
  if (!container) return;

  if (!data || !data.length) {
    container.innerHTML = "<p>No matching products found.</p>";
    return;
  }

  // De-duplicate by FULL NAME
  const seen = new Set();
  const clean = data.filter(p => {
    const key = p["FULL NAME"] || "";
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  window._lastResults = clean;

  container.innerHTML = `
    <div class="pane" style="margin:8px 0; padding:8px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <b>Sort:</b>
      <select id="sortSelect" style="padding:4px; font-size:12px; border-radius:10px">
        <option value="name-asc">Product A â†’ Z</option>
        <option value="name-desc">Product Z â†’ A</option>
        <option value="price-asc">Price Low â†’ High</option>
        <option value="price-desc">Price High â†’ Low</option>
        <option value="valuepair-asc">Value/Pair Low â†’ High</option>
        <option value="valuepair-desc">Value/Pair High â†’ Low</option>
      </select>
    </div>
    <div id="cardsGrid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(360px,1fr)); gap:10px;"></div>
  `;

  buildCards(clean);

  const sortEl = document.getElementById("sortSelect");
  if (sortEl) {
    sortEl.addEventListener("change", e => {
      const val = e.target.value;
      const items = [...(window._lastResults || [])];

      if (val.startsWith("name")) {
        const dir = val.endsWith("asc") ? 1 : -1;
        items.sort((a,b) => (a["FULL NAME"]||"").localeCompare(b["FULL NAME"]||"", undefined, {sensitivity:"base"}) * dir);
      } else if (val.startsWith("price")) {
        const dir = val.endsWith("asc") ? 1 : -1;
        items.sort((a,b) => (getNumericPrice(a) - getNumericPrice(b)) * dir);
      } else if (val.startsWith("valuepair")) {
        const dir = val.endsWith("asc") ? 1 : -1;
        items.sort((a,b) => (getNumericValuePerPair(a) - getNumericValuePerPair(b)) * dir);
      }

      buildCards(items);
    });
  }
}

// ---------- Card grid builder ----------
function buildCards(list){
  const grid = document.getElementById("cardsGrid");
  if (!grid) return;

  const H_DISPOSE = "MODALITY (1 DAY, 2 WEEKS, 1 MONTH, 3 MONTHS)";
  const H_PRICE   = "1 BOX PRICE & UNIT";
  const H_MAT     = "COMFORT & MATERIAL";
  const H_VALUE   = "VALUE_PER_PAIR";
  const H_PROMO   = "PROMO";
  const IMG_W = 320;

  const html = list.map(p => {
    const name     = p["FULL NAME"] || "";
    const promo    = (p[H_PROMO] || "").trim();
    const hasPromo = promo.length > 0;

    const photoKey = (p["PHOTO"] || "").trim();
    const hasPhoto = !!photoKey;
    const photoURL = hasPhoto
      ? `https://raw.githubusercontent.com/kiaraoptometrypx/CL-SELECTOR/main/CL-PHOTOS/${photoKey}.png`
      : "";

    return `
      <div class="pane lens-card" style="position:relative;">
        ${hasPromo ? `<div style="
          position:absolute; top:6px; left:6px;
          background:#d60000; color:white;
          padding:2px 6px; font-size:10px;
          border-radius:10px; font-weight:700;
          box-shadow:0 1px 3px rgba(0,0,0,.3);
        ">ðŸ”¥ ${promo}</div>` : ""}

        <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
          <div style="flex:0 0 ${IMG_W}px; max-width:100%;">
            ${
              hasPhoto
              ? `<img src="${photoURL}" alt="${name}"
                   style="width:${IMG_W}px; max-width:100%; height:auto;
                   border:1px solid #ccc; border-radius:10px; cursor:zoom-in;"
                   onclick="window.__openZoom && window.__openZoom('${photoURL}','${name.replace(/'/g,"\\'")}')"
                   onerror="this.style.display='none'">`
              : `<div style="width:${IMG_W}px; height:${Math.round(IMG_W*2/3)}px;
                   display:flex; align-items:center; justify-content:center;
                   color:#666; border:1px dashed #ccc; border-radius:10px;">No photo</div>`
            }
          </div>

          <div style="flex:1; min-width:220px; display:flex; flex-direction:column; gap:8px;">
            <div style="font-weight:700;">${name}</div>
            <div><b>Dispose Period:</b> ${p[H_DISPOSE] || ""}</div>
            <div><b>Comfort & Material:</b> ${p[H_MAT] || ""}</div>
            <div><b>Average cost per pair:</b> ${p[H_VALUE] || "-"}</div>
			<div style="height:5px"></div>
            <div><b>Price Per Pack & Qty:</b> ${p[H_PRICE] || ""}</div>
            <div><b>Current Promo:</b> ${hasPromo ? promo : "Not at the moment"}</div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  grid.innerHTML = html;
}



</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const overlay = document.getElementById('imgZoom');
  const imgEl   = document.getElementById('imgZoomEl');
  if (!overlay || !imgEl) return;

  function openZoom(src, alt=''){
    imgEl.src = src;
    imgEl.alt = alt || '';
    overlay.classList.add('open');
    imgEl.dataset.zoom = '1';
    imgEl.style.transform = 'scale(1)';
  }
  function closeZoom(){
    overlay.classList.remove('open');
    imgEl.src = '';
    imgEl.alt = '';
  }

  overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeZoom(); });
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && overlay.classList.contains('open')) closeZoom(); });
  imgEl.addEventListener('dblclick', ()=>{
    const z = imgEl.dataset.zoom === '2' ? '1' : '2';
    imgEl.dataset.zoom = z;
    imgEl.style.transform = (z === '2') ? 'scale(2)' : 'scale(1)';
  });

  // make available to <img onclick=...>
  window.__openZoom = openZoom;
});
</script>


<!-- ðŸ” Image lightbox -->
<div id="imgZoom" aria-modal="true" role="dialog">
  <div class="inner">
    <img id="imgZoomEl" alt="">
    <div class="hint">Click outside or press Esc to close</div>
  </div>
</div>
















<script>
(function(){
  const CL_CYL_STEPS = [-0.75,-1.25,-1.75,-2.25,-2.75];
  let latest = { re:null, le:null };

  function glassesToCL(F){ const d=0.01; return F/(1 - d*F); }
  function r025(x){ return Math.round(x/0.25)*0.25; }
  function fmt(x){ x=parseFloat(x)||0; const v=Math.round(x*100)/100; const s=v>=0?"+":""; return s+v.toFixed(2); }
  function nearest(arr,val){ return arr.reduce((b,v)=>Math.abs(v-val)<Math.abs(b-val)?v:b,arr[0]); }
  function roundDown025(x){ return Math.floor(x/0.25)*0.25; }

  // Auto-normalize input
  document.querySelectorAll("#specToCL input[type=number]").forEach(inp=>{
    inp.addEventListener("blur",()=>{
      let v=parseFloat(inp.value);
      if(isNaN(v)){inp.value="";return;}
      if(inp.id.includes("axis")){
        v=Math.round(v); if(v<=0)v=180; if(v>180)v=v%180||180;
        inp.value=v;
      }else{
        v=r025(v);
        inp.value=(v>0?"+":"")+v.toFixed(2);
      }
    });
  });

  function flatterAxis(a){
    // decide base 10Â° step and flatten logic
    const rem = Math.round(a/10)*10;
    let t1,t2;
    if(a<90){ t1=Math.max(0,rem-10); t2=rem+10; }
    else if(a>90){ t1=Math.min(180,rem+10); t2=rem-10; }
    else { t1=90; t2=100; }
    if(t1===0) t1=180; // never show 0
    if(t2<=0) t2+=180;
    return [t1,t2];
  }

  function convertOne(S,C,A){
    S=parseFloat(S)||0; C=parseFloat(C)||0; A=parseFloat(A)||0;
    const total=S+C;
    const convS=glassesToCL(S);
    const convT=glassesToCL(total);
    const newC=convT-convS;
    const SE=convS+newC/2;
    const rS=r025(convS);
    const rC=nearest(CL_CYL_STEPS,newC);
    const [axis1,axis2]=flatterAxis(A);

    if(Math.abs(newC)<0.75){
      return { type:"sph", sph:r025(SE), cyl:0, axis:null, SE:roundDown025(SE) };
    }

    // Toric 1/2/3
    const t1={S:rS,C:rC,A:axis1};
    const t2={S:rS,C:rC,A:axis2};
    let t3C=rC+0.5; if(t3C>-0.75)t3C=0;
    const t3={S:rS-0.25,C:t3C,A:axis1};
    const se=roundDown025(SE);

    return { type:"toric", t1,t2,t3,SE:se };
  }

  function display(side,data){
    const div=document.getElementById(side==="re"?"reResult":"leResult");
    if(!div)return;

if(data.type==="sph"){
div.innerHTML=`${side.toUpperCase()} Spherical : S${fmt(data.sph)}`;
return; // stop here; don't append SE again

}

else{
      const t=(t,n)=>`${side.toUpperCase()} Toric ${n} : S${fmt(t.S)} C${fmt(t.C)} Ã—${t.A}`;
const se=`${side.toUpperCase()} Spherical : S${fmt(data.SE)}`;
div.innerHTML=[t(data.t1,1),t(data.t2,2),t(data.t3,3),se].join("<br>");

    }
  }

  document.getElementById("convertBtn").addEventListener("click",()=>{
    const re=convertOne(
      document.getElementById("sph-re").value,
      document.getElementById("cyl-re").value,
      document.getElementById("axis-re").value
    );
    const le=convertOne(
      document.getElementById("sph-le").value,
      document.getElementById("cyl-le").value,
      document.getElementById("axis-le").value
    );
    display("re",re); display("le",le);
    latest.re=re; latest.le=le;
  });

  function autofillSet(set){
    const reBox=document.getElementById("searchRE");
    const leBox=document.getElementById("searchLE");
    if(!reBox||!leBox)return;
    const f=(d)=>{
      if(!d)return"";
if(d.type==="sph") return `S${fmt(d.sph)} C-0.00`;
      const sel=d[set];
      if(!sel) return `S${fmt(d.SE)}`;
      return `S${fmt(sel.S)} C${fmt(sel.C)} x${sel.A}`;
    };
    reBox.value=f(latest.re);
    leBox.value=f(latest.le);
  }

  document.getElementById("auto1").addEventListener("click",()=>autofillSet("t1"));
  document.getElementById("auto2").addEventListener("click",()=>autofillSet("t2"));
  document.getElementById("auto3").addEventListener("click",()=>autofillSet("t3"));
  document.getElementById("autoSE").addEventListener("click",()=>autofillSet("SE"));
})();
</script>










</body>
</html>











